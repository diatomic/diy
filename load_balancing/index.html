
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://example.com/load_balancing/">
      
      
        <link rel="prev" href="../algorithms/">
      
      
        <link rel="next" href="../ooc/">
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Dynamic load balancing - DIY</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#dynamic-load-balancing" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="DIY" class="md-header__button md-logo" aria-label="DIY" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            DIY
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Dynamic load balancing
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="DIY" class="md-nav__button md-logo" aria-label="DIY" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    DIY
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../initialization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Initialization
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../decomposition/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Domain decomposition
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../callbacks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Callback functions
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Communication
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Communication
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../local_comm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Local synchronous communication
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../remote_comm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Remote communication
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../async_comm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Asynchronous communication
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../reduce_comm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Global communication (reductions)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../io/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Block I/O
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../serialization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Serialization
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../mpi/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    MPI convenience wrapper
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../algorithms/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Algorithms
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Dynamic load balancing
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Dynamic load balancing
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#parameter-recommendations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameter Recommendations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Parameter Recommendations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#work-estimation-function" class="md-nav__link">
    <span class="md-ellipsis">
      
        Work Estimation Function
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compute-callback-function" class="md-nav__link">
    <span class="md-ellipsis">
      
        Compute Callback Function
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamicassigner" class="md-nav__link">
    <span class="md-ellipsis">
      
        DynamicAssigner
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#complete-example" class="md-nav__link">
    <span class="md-ellipsis">
      
        Complete Example
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Complete Example">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#block-structure-with-work-information" class="md-nav__link">
    <span class="md-ellipsis">
      
        Block Structure with Work Information
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#work-assignment" class="md-nav__link">
    <span class="md-ellipsis">
      
        Work Assignment
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#work-estimation-function_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Work Estimation Function
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compute-function" class="md-nav__link">
    <span class="md-ellipsis">
      
        Compute Function
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-load-balancing-execution" class="md-nav__link">
    <span class="md-ellipsis">
      
        Dynamic Load Balancing Execution
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ooc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Writing out-of-core algorithms
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../coroutine/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Coroutines
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../threads/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Automatic block threading
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Examples
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#parameter-recommendations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameter Recommendations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Parameter Recommendations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#work-estimation-function" class="md-nav__link">
    <span class="md-ellipsis">
      
        Work Estimation Function
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compute-callback-function" class="md-nav__link">
    <span class="md-ellipsis">
      
        Compute Callback Function
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamicassigner" class="md-nav__link">
    <span class="md-ellipsis">
      
        DynamicAssigner
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#complete-example" class="md-nav__link">
    <span class="md-ellipsis">
      
        Complete Example
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Complete Example">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#block-structure-with-work-information" class="md-nav__link">
    <span class="md-ellipsis">
      
        Block Structure with Work Information
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#work-assignment" class="md-nav__link">
    <span class="md-ellipsis">
      
        Work Assignment
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#work-estimation-function_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Work Estimation Function
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compute-function" class="md-nav__link">
    <span class="md-ellipsis">
      
        Compute Function
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-load-balancing-execution" class="md-nav__link">
    <span class="md-ellipsis">
      
        Dynamic Load Balancing Execution
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="dynamic-load-balancing">Dynamic Load Balancing</h1>
<p>Dynamic load balancing automatically redistributes blocks across processes to balance computational workload. This is useful when different blocks require different amounts of computation time, leading to some processes finishing much earlier than others.</p>
<p>In many parallel applications, the computational cost of processing different blocks varies significantly. Without load balancing, some processes may become idle while others are still processing their expensive blocks. DIY's dynamic load balancing solves this by:</p>
<ul>
<li>Monitoring workload across processes</li>
<li>Identifying overloaded processes (those with blocks requiring high computation)</li>
<li>Moving blocks from overloaded to underloaded processes</li>
<li>Continuing computation with improved load balance</li>
</ul>
<p>Dynamic load balancing is most beneficial in applications where:</p>
<ul>
<li>Different blocks have varying computational complexity</li>
<li>The computational cost cannot be easily predicted beforehand</li>
<li>The workload may change during execution</li>
</ul>
<p>Dynamic load balancing replaces the <code>foreach</code> operation with <code>dynamic_foreach</code> that automatically combines dynamic load balancing with block computation.
The <code>dynamic_foreach()</code> method executes blocks while monitoring workload and moving blocks between processes as needed.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kt">void</span><span class="w"> </span><span class="n">dynamic_foreach</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">F</span><span class="o">&amp;</span><span class="w">         </span><span class="n">compute_function</span><span class="p">,</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="w">                     </span><span class="k">const</span><span class="w"> </span><span class="n">G</span><span class="o">&amp;</span><span class="w">         </span><span class="n">work_function</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">                     </span><span class="n">DynamicAssigner</span><span class="o">&amp;</span><span class="w"> </span><span class="n">dynamic_assigner</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">                     </span><span class="kt">float</span><span class="w">            </span><span class="n">sample_frac</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">                     </span><span class="kt">float</span><span class="w">            </span><span class="n">quantile</span><span class="p">)</span>
</code></pre></div>
<p>Parameters:</p>
<ul>
<li><code>compute_function</code>: Callback function that performs computation on each block</li>
<li><code>work_function</code>: Callback function that returns estimated work for each block, in whatever units the user chooses</li>
<li><code>dynamic_assigner</code>: DynamicAssigner object that tracks block locations</li>
<li><code>sample_frac</code>: Fraction of processes to sample for load information (0.0-1.0)</li>
<li><code>quantile</code>: Cutoff threshold above which blocks are considered for moving (0.0-1.0)</li>
</ul>
<h2 id="parameter-recommendations">Parameter Recommendations</h2>
<p><strong>sample_frac</strong>: Controls the fraction of processes sampled for load information</p>
<ul>
<li><code>0.5f</code> (default): Sample half the processes - good balance between accuracy and communication overhead</li>
<li>Lower values (e.g., <code>0.3f</code>): Less communication overhead but less accurate load information</li>
<li>Higher values (e.g., <code>0.8f</code>): More accurate load information but higher communication overhead</li>
</ul>
<p><strong>quantile</strong>: Controls the threshold for identifying overloaded blocks</p>
<ul>
<li><code>0.8f</code> (default): Move blocks from top 20% most loaded processes - moderate load balancing</li>
<li>Lower values (e.g., <code>0.6f</code>): More aggressive load balancing, moves more blocks</li>
<li>Higher values (e.g., <code>0.9f</code>): Less aggressive load balancing, moves fewer blocks</li>
</ul>
<h3 id="work-estimation-function">Work Estimation Function</h3>
<p>A callback function that returns the estimated computational work for each block. The work can be any user-defined measure (e.g., number of operations, estimated time, complexity units).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="n">diy</span><span class="o">::</span><span class="n">Work</span><span class="w"> </span><span class="nf">get_block_work</span><span class="p">(</span><span class="n">Block</span><span class="o">*</span><span class="w"> </span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">gid</span><span class="p">)</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="p">{</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">block</span><span class="o">-&gt;</span><span class="n">estimated_work</span><span class="p">;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="p">}</span>
</code></pre></div>
<h3 id="compute-callback-function">Compute Callback Function</h3>
<p>A user-defined function that performs the actual computation on each block. This is the same type of function used with regular <code>foreach()</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">compute</span><span class="p">(</span><span class="n">Block</span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">diy</span><span class="o">::</span><span class="n">Master</span><span class="o">::</span><span class="n">ProxyWithLink</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cp</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">max_time</span><span class="p">)</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="p">{</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">    </span><span class="c1">// Perform the actual computation for this block</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">    </span><span class="c1">// Use b-&gt;data to access block data</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">    </span><span class="c1">// Use cp for communication if needed</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="p">}</span>
</code></pre></div>
<h3 id="dynamicassigner">DynamicAssigner</h3>
<p>The <code>diy::DynamicAssigner</code> is a special assigner that tracks the current location of blocks as they move between processes during load balancing.
The user creates the dynamic assigner and initializes it with the local block id's before starting the computation.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="n">diy</span><span class="o">::</span><span class="n">DynamicAssigner</span><span class="w"> </span><span class="n">dynamic_assigner</span><span class="p">(</span><span class="n">world</span><span class="p">,</span><span class="w"> </span><span class="n">world</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span><span class="w"> </span><span class="n">nblocks</span><span class="p">)</span>
</code></pre></div>
<p>Parameters:</p>
<ul>
<li><code>world</code>: MPI communicator</li>
<li><code>world.size()</code>: Total number of MPI processes</li>
<li><code>nblocks</code>: Total number of blocks in the global domain</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="n">diy</span><span class="o">::</span><span class="n">record_local_gids</span><span class="p">(</span><span class="n">master</span><span class="p">,</span><span class="w"> </span><span class="n">dynamic_assigner</span><span class="p">)</span>
</code></pre></div>
<h2 id="complete-example">Complete Example</h2>
<p>Below are the key snippets from <code>examples/load_balancing/dynamic.cpp</code> showing the essential load balancing components.</p>
<h3 id="block-structure-with-work-information">Block Structure with Work Information</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Block</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="p">{</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="nf">create</span><span class="p">()</span><span class="w">            </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Block</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">  </span><span class="nf">destroy</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="k">delete</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Block</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">b</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">    </span><span class="c1">// Block data</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">    </span><span class="kt">int</span><span class="w">                 </span><span class="n">gid</span><span class="p">;</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="w">    </span><span class="n">diy</span><span class="o">::</span><span class="n">Work</span><span class="w">           </span><span class="n">estimated_work</span><span class="p">;</span><span class="w">      </span><span class="c1">// Estimated work for this block</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="w">    </span><span class="c1">// ... other user data</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="p">};</span>
</code></pre></div>
<h3 id="work-assignment">Work Assignment</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1">// Assign work to blocks (e.g., based on data size, complexity, etc.)</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="n">master</span><span class="p">.</span><span class="n">foreach</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Block</span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">diy</span><span class="o">::</span><span class="n">Master</span><span class="o">::</span><span class="n">ProxyWithLink</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cp</span><span class="p">)</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">               </span><span class="p">{</span><span class="w"> </span><span class="n">b</span><span class="o">-&gt;</span><span class="n">assign_work</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">noise_factor</span><span class="p">,</span><span class="w"> </span><span class="n">distribution</span><span class="p">,</span><span class="w"> </span><span class="n">generator</span><span class="p">);</span><span class="w"> </span><span class="p">});</span>
</code></pre></div>
<h3 id="work-estimation-function_1">Work Estimation Function</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="n">diy</span><span class="o">::</span><span class="n">Work</span><span class="w"> </span><span class="nf">get_block_work</span><span class="p">(</span><span class="n">Block</span><span class="o">*</span><span class="w"> </span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">gid</span><span class="p">)</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="p">{</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">    </span><span class="n">DIY_UNUSED</span><span class="p">(</span><span class="n">gid</span><span class="p">);</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">block</span><span class="o">-&gt;</span><span class="n">estimated_work</span><span class="p">;</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="p">}</span>
</code></pre></div>
<h3 id="compute-function">Compute Function</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">Block::compute</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">diy</span><span class="o">::</span><span class="n">Master</span><span class="o">::</span><span class="n">ProxyWithLink</span><span class="o">&amp;</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">max_time</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="p">{</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">    </span><span class="c1">// Simulate computation proportional to work amount</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">usec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max_time</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">act_work</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">10000L</span><span class="p">;</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">microseconds</span><span class="p">(</span><span class="n">usec</span><span class="p">));</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="p">}</span>
</code></pre></div>
<h3 id="dynamic-load-balancing-execution">Dynamic Load Balancing Execution</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1">// Create and initialize dynamic assigner</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="n">diy</span><span class="o">::</span><span class="n">DynamicAssigner</span><span class="w"> </span><span class="nf">dynamic_assigner</span><span class="p">(</span><span class="n">world</span><span class="p">,</span><span class="w"> </span><span class="n">world</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span><span class="w"> </span><span class="n">nblocks</span><span class="p">);</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="n">diy</span><span class="o">::</span><span class="n">record_local_gids</span><span class="p">(</span><span class="n">master</span><span class="p">,</span><span class="w"> </span><span class="n">dynamic_assigner</span><span class="p">);</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="n">world</span><span class="p">.</span><span class="n">barrier</span><span class="p">();</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="c1">// Execute with dynamic load balancing</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="n">master</span><span class="p">.</span><span class="n">dynamic_foreach</span><span class="p">(</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="w">    </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Block</span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">diy</span><span class="o">::</span><span class="n">Master</span><span class="o">::</span><span class="n">ProxyWithLink</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cp</span><span class="p">)</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="n">b</span><span class="o">-&gt;</span><span class="n">compute</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span><span class="w"> </span><span class="n">max_time</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span><span class="w"> </span><span class="p">},</span><span class="w">        </span><span class="c1">// compute function</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="w">    </span><span class="o">&amp;</span><span class="n">get_block_work</span><span class="p">,</span><span class="w">                         </span><span class="c1">// work estimation function</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="w">    </span><span class="n">dynamic_assigner</span><span class="p">,</span><span class="w">                        </span><span class="c1">// dynamic assigner</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="w">    </span><span class="n">sample_frac</span><span class="p">,</span><span class="w">                             </span><span class="c1">// sample fraction (e.g., 0.5f)</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="w">    </span><span class="n">quantile</span><span class="p">);</span><span class="w">                               </span><span class="c1">// quantile (e.g., 0.8f)</span>
</code></pre></div>
<p>The dynamic load balancing will automatically move blocks from overloaded processes to underloaded ones during execution, improving overall performance and utilization.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": [], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>